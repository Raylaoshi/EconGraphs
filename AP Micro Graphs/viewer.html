<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AP.Econ.Graphs</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Noto+Sans+SC:wght@300;400;500;700&family=Outfit:wght@300;400;500;600;700&family=Syne:wght@700;800&display=swap" rel="stylesheet" />

    <!-- KGJS — loaded statically so it fires on DOMContentLoaded and finds content -->
    <link href="https://raylaoshi.github.io/AP.Econ.Graphs/lib/kg.0.4.0.css" rel="stylesheet" type="text/css">
    <script src="https://raylaoshi.github.io/AP.Econ.Graphs/lib/kg.0.4.0.js"></script>

    <!-- Helper functions defined early so inline sync script below can use them -->
    <script>
        // Strip front-matter lines, return from 'schema:' onward
        function stripFrontMatter(yaml) {
            const idx = yaml.indexOf('\nschema:');
            if (idx >= 0) return yaml.slice(idx + 1);
            // fallback: starts with schema:
            if (yaml.startsWith('schema:')) return yaml;
            return yaml;
        }

        // Parse front-matter fields before 'schema:' line
        // Supports single-line values and block scalars (|)
        function parseFrontMatter(yaml) {
            const result = {
                title: '', title_zh: '',
                description: '', description_zh: '',
                label: '', eyebrow: '', eyebrow_zh: ''
            };
            const FIELDS = Object.keys(result);
            const lines = yaml.split('\n');
            let i = 0, blockKey = null, blockLines = [];

            function flushBlock() {
                if (blockKey) {
                    result[blockKey] = blockLines.join('\n').trim();
                    blockKey = null; blockLines = [];
                }
            }

            while (i < lines.length) {
                const line = lines[i];
                if (/^schema:/.test(line)) { flushBlock(); break; }
                if (blockKey !== null) {
                    if (line.startsWith('  ') || line.trim() === '') {
                        blockLines.push(line.trim()); i++;
                    } else { flushBlock(); continue; }
                } else {
                    const m = line.match(/^([a-zA-Z_]+):\s*(.*)/);
                    if (m && FIELDS.includes(m[1])) {
                        const [, key, val] = m;
                        if (val.trim() === '|' || val.trim() === '>') {
                            blockKey = key; blockLines = [];
                        } else {
                            result[key] = val.trim().replace(/^["']|["']$/g, '');
                        }
                    }
                    i++;
                }
            }
            flushBlock();
            return result;
        }
    </script>

    <style>
        :root {
            --bg: #fcfbf9;
            --ink: #050e3c;
            --mid: #002455;
            --faint: #f2f0eb;
            --line: #e6e4e0;
            --red: #DC0000;
            --red-dim: #fce8e8;
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }

        body {
            background: #ffffff;
            color: var(--ink);
            font-family: 'Outfit', 'Noto Sans SC', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            font-weight: 300;
            line-height: 1.7;
            -webkit-font-smoothing: antialiased;
            opacity: 0;
            transition: opacity 0.4s ease-in-out;
        }

        /* ── TOPBAR ── */
        .topbar {
            position: relative; z-index: 100;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 clamp(1rem,4vw,2rem); height: 64px;
            border-bottom: 1px solid var(--line);
            background: rgba(252,251,249,.95); backdrop-filter: blur(12px);
        }
        .logo {
            font-family: 'Syne', 'SF Pro Display', 'PingFang SC', sans-serif;
            font-weight: 800; font-size: clamp(.85rem,2vw,1.1rem);
            letter-spacing: -.02em; color: var(--ink); text-decoration: none;
        }
        .logo span { color: var(--red); }
        .topbar-right { display: flex; align-items: center; gap: 1rem; }
        .lang-toggle { display: flex; gap: 6px; }
        .lang-btn {
            background: none; border: 1px solid var(--line); border-radius: 6px;
            padding: .3rem .85rem; font-size: .78rem; font-family: inherit;
            cursor: pointer; color: var(--mid); transition: all .18s; font-weight: 500;
        }
        .lang-btn:hover { border-color: var(--mid); }
        .lang-btn.active { background: var(--ink); color: #fff; border-color: var(--ink); }

        /* ── PAGE HEADER ── */
        .page-header-wrap { border-bottom: 1px solid var(--line); background: #fff; }
        .page-header {
            max-width: 1100px; margin: 0 auto;
            padding: clamp(2rem,5vw,4rem) clamp(1rem,4vw,2rem) clamp(1rem,3vw,2rem);
        }
        .breadcrumb {
            display: flex; align-items: center; gap: .4rem; flex-wrap: wrap;
            margin-bottom: 1.2rem;
        }
        .back-btn {
            display: inline-flex; align-items: center; gap: .4rem;
            background: var(--faint); border: 1px solid var(--line);
            color: var(--ink); text-decoration: none;
            font-family: 'Outfit', sans-serif;
            font-weight: 600; font-size: .8rem; padding: .5rem 1.1rem;
            border-radius: 6px; transition: all .18s; cursor: pointer;
        }
        .back-btn:hover { background: var(--ink); color: #fff; border-color: var(--ink); }
        .breadcrumb .sep { color: var(--line); font-size: .9rem; margin: 0 .2rem; }
        .breadcrumb .folder-link {
            color: var(--mid); text-decoration: none; font-size: .85rem; transition: color .2s;
        }
        .breadcrumb .folder-link:hover { color: var(--ink); text-decoration: underline; }
        .breadcrumb .code-label { color: var(--mid); font-size: .85rem; }

        .page-eyebrow {
            font-size: clamp(.65rem,1.5vw,.75rem); letter-spacing: .15em;
            text-transform: uppercase; color: var(--mid);
            margin-bottom: 1rem; font-weight: 600; min-height: 1em;
        }
        .page-header h1 {
            font-family: 'Outfit', sans-serif; font-weight: 700;
            font-size: clamp(2.2rem,6vw,3.8rem); 
            line-height: 1.1; color: var(--ink); min-height: 1.1em;
        }

        /* ── DESCRIPTION ── */
        .page-desc {
            margin-top: 1.2rem; font-size: clamp(.95rem,2vw,1.05rem);
            color: var(--mid); line-height: 1.7; max-width: 800px;
        }
        .page-desc p { margin-bottom: 0.8rem; }
        .page-desc strong { color: var(--ink); font-weight: 600; }
        .page-desc ol, .page-desc ul { margin-left: 1.5rem; margin-top: 0.5rem; }
        .page-desc li { margin-bottom: 0.3rem; }
        .page-desc li strong { color: var(--ink); font-weight: 600; }
        :lang(zh) .page-desc { line-height: 1.8; letter-spacing: 0.02em; }

        /* ── MAIN ── */
        main {
            max-width: 1100px; margin: 0 auto;
            padding: 0 clamp(1rem,4vw,2rem) clamp(4rem,8vw,6rem);
            position: relative;
        }

        /* ── ERROR STATE ── */
        .error-msg {
            padding: 4rem 0; text-align: center;
            color: var(--red); font-size: .9rem; display: none;
        }

        /* ── GRAPH WRAPPER (positions overlay) ── */
        #kg-wrapper {
            position: relative;
            max-width: 1100px;
            margin: 3rem 0 1rem 0;
            border-radius: 12px;
        }

        /* ── GRAPH CONTAINER ── */
        .kg-container {
            background: #ffffff;
            border-radius: 12px;
            user-select: none;
            -webkit-user-select: none;
        }

        svg text { pointer-events: none; }

        /* force theme*/
        .kg-container div, 
        .kg-container span, 
        .kg-container p {
            font-family: 'Outfit', sans-serif !important;            
            font-size: 0.9rem !important;
        }

        .kg-container text {
            font-family: 'Outfit', sans-serif !important;
        }
        
        /* ── KGJS Sidebar text overrides ── */

        /* All plain text and divs inside sidebar */
        .sidebar div,
        .sidebar span,
        .sidebar p {
            font-size: 0.9rem !important;
        }

        /* Slider labels (has a class) */
        .slider-label {
            font-size: 0.9rem !important;
        }

        /* Slider number inputs (has a class) */
        .slider-numberInput {
            font-size: 0.9rem !important;
            font-family: 'Outfit', sans-serif !important;
           
        }

        /* Checkbox label (has a class) */
        .checkbox-label {
            font-size: 0.9rem !important;
        }

        /* Range slider track width if you want narrower sidebar */
        .sidebar input[type="range"] {
            width: 100% !important;
        }

        #rotate-overlay {
            display: none;
            position: absolute;
            inset: 0;
            z-index: 100;
            background: rgba(5, 14, 60, 0.92);
            color: #fff;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-family: 'Outfit', sans-serif;
            padding: 2rem;
            gap: 0.8rem;
            border-radius: 12px;
        }
        #rotate-overlay.show { display: flex; }
        #rotate-overlay .icon { font-size: 2.5rem; }
        #rotate-overlay p { font-size: 0.9rem; line-height: 1.6; opacity: 0.85; margin: 0; }
        #rotate-overlay .dismiss-btn {
            margin-top: 0.8rem;
            background: none;
            border: 1px solid rgba(255,255,255,0.4);
            color: #fff;
            font-family: 'Outfit', sans-serif;
            font-size: 0.78rem;
            padding: 0.4rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        #rotate-overlay .dismiss-btn:hover { opacity: 1; }

        @media (max-width: 600px) {
            .page-header { padding-top: 2rem; }
            .kg-container { margin-top: 2rem; 
            /* Stack KG's layout vertically on narrow screens */
            transform: none;
            overflow-x: auto; /* allow horizontal scroll as last resort */
            }}
    </style>
</head>

<body>

<header class="topbar">
    <a class="logo" href="../index.html"><span>AP</span>·Econ·Graphs</a>
    <div class="topbar-right">
        <div class="lang-toggle">
            <button class="lang-btn active" id="btn-en" onclick="setLang('en')">EN</button>
            <button class="lang-btn" id="btn-zh" onclick="setLang('zh')">中文</button>
        </div>
    </div>
</header>

<div class="page-header-wrap">
    <div class="page-header">
        <div class="breadcrumb">
            <a class="back-btn" href="javascript:history.back()" id="back-btn">↖ Back</a>
            <span class="sep">/</span>
            <a href="index.html" class="folder-link" id="breadcrumb-folder"></a>
            <span class="sep">/</span>
            <span class="code-label" id="breadcrumb-code"></span>
        </div>
        <div class="page-eyebrow" id="page-eyebrow"></div>
        <h1 id="page-title"></h1>
        <div class="page-desc" id="page-desc"></div>
    </div>
</div>

<main>
    <div class="error-msg" id="error-msg"></div>

    <!--
        ┌─────────────────────────────────────────────────────────┐
        │  SYNCHRONOUS YAML INJECTION                             │
        │                                                         │
        │  The <script> immediately below runs synchronously      │
        │  during page parsing — BEFORE DOMContentLoaded fires.   │
        │  It fetches the YAML via synchronous XHR and injects    │
        │  it directly into .kg-container.                        │
        │                                                         │
        │  KG is loaded statically in <head> and fires its init   │
        │  on DOMContentLoaded — by which time the content is     │
        │  guaranteed to already be present. Race condition = 0.  │
        └─────────────────────────────────────────────────────────┘
    -->
    <div id="kg-wrapper">
        <div id="rotate-overlay">
            <div class="icon">⟳</div>
            <p>Rotate to landscape for the best experience.</p>
            <p><b>横屏效果更佳。</b></p>
            <button class="dismiss-btn" id="dismiss-rotate">✖</button>
        </div>
        <div class="kg-container" id="kg-content"></div>
    </div>
    <script>
        (function () {
            const graphId = new URLSearchParams(location.search).get('graph');
            if (!graphId) return;

            try {
                const xhr = new XMLHttpRequest();
                xhr.open('GET', 'graphs/' + encodeURIComponent(graphId) + '.yaml', false); // false = synchronous
                xhr.send(null);

                if (xhr.status === 200) {
                    // Inject stripped YAML — content is in DOM before DOMContentLoaded
                    document.getElementById('kg-content').textContent = stripFrontMatter(xhr.responseText);
                    // Store full text for metadata rendering in DOMContentLoaded below
                    window._kgYaml = xhr.responseText;
                } else {
                    window._kgError = 'HTTP ' + xhr.status;
                }
            } catch (e) {
                window._kgError = e.message;
            }
        })();
    </script>
</main>

<script>
// ── i18n & rendering — runs on DOMContentLoaded (after KG has already init'd) ──

const FOLDER_ZH = {
    'AP Micro Graphs':      'AP微观经济图像',
    'AP Macro Graphs':      'AP宏观经济图像',
    'Previous Experiments': '图像试验',
};

const UI = {
    en: { back: '↖ Back',
          errorNotFound: '⚠️ Graph not found. Make sure the .yaml file exists in graphs/',
          errorNoId:     '⚠️ No graph specified. Add ?graph=3.2.G1 to the URL.' },
    zh: { back: '↖ 返回', 
          errorNotFound: '⚠️ 找不到图像，请确认 .yaml 文件存在于 graphs/ 文件夹中。',
          errorNoId:     '⚠️ 未指定图像，请在 URL 中添加 ?graph=3.2.G1。' },
};

let currentLang = 'en';

function render(lang, meta) {
    meta = meta || {};

    // Static UI
    document.getElementById('back-btn').textContent      = UI[lang].back;

    // Breadcrumb folder
    const parts = window.location.pathname.split('/');
    const folderName = decodeURIComponent(parts[parts.length - 2] || '');
    document.getElementById('breadcrumb-folder').textContent =
        lang === 'zh' ? (FOLDER_ZH[folderName] || folderName) : folderName;

    // Code label
    document.getElementById('breadcrumb-code').textContent = meta.label || '';

    // Eyebrow
    document.getElementById('page-eyebrow').textContent =
        (lang === 'zh' && meta.eyebrow_zh) ? meta.eyebrow_zh : (meta.eyebrow || '');

    // Title
    document.getElementById('page-title').textContent =
        (lang === 'zh' && meta.title_zh) ? meta.title_zh : (meta.title || '');

    // Description (innerHTML — supports HTML tags)
    document.getElementById('page-desc').innerHTML =
        (lang === 'zh' && meta.description_zh) ? meta.description_zh : (meta.description || '');

    document.getElementById('btn-en').classList.toggle('active', lang === 'en');
    document.getElementById('btn-zh').classList.toggle('active', lang === 'zh');
    document.documentElement.lang = lang === 'zh' ? 'zh' : 'en';
}

function setLang(lang) {
    currentLang = lang;
    // Re-render with stored meta
    render(lang, window._kgMeta || {});
    try { localStorage.setItem('econ-lang', lang); } catch(e) {}
}

function detectLang() {
    try {
        const saved = localStorage.getItem('econ-lang');
        if (saved === 'en' || saved === 'zh') return saved;
    } catch(e) {}
    return (navigator.language || '').toLowerCase().startsWith('zh') ? 'zh' : 'en';
}

document.addEventListener('DOMContentLoaded', function () {
    currentLang = detectLang();

    const graphId = new URLSearchParams(location.search).get('graph');

    // Handle errors from sync XHR above
    if (!graphId) {
        document.getElementById('error-msg').textContent = UI[currentLang].errorNoId;
        document.getElementById('error-msg').style.display = 'block';
        document.getElementById('kg-wrapper').style.display = 'none';        render(currentLang, {});
    } else if (window._kgError) {
        document.getElementById('error-msg').textContent = UI[currentLang].errorNotFound;
        document.getElementById('error-msg').style.display = 'block';
        document.getElementById('kg-wrapper').style.display = 'none';
        render(currentLang, {});
    } else if (window._kgYaml) {
        // Parse metadata and render UI
        const meta = parseFrontMatter(window._kgYaml);
        window._kgMeta = meta;
        document.title = (meta.title || graphId) + ' — AP.Econ.Graphs';
        render(currentLang, meta);
    }

    // KG drag fix
    const container = document.getElementById('kg-content');
    if (container) {
        container.addEventListener('mousedown', function (e) {
            if (e.target.closest('svg')) e.preventDefault();
        }, true);
    }

    requestAnimationFrame(() => {
        requestAnimationFrame(() => {
            document.body.style.opacity = '1';
        });
    });
});

let overlayDismissed = false;

document.getElementById('dismiss-rotate').addEventListener('click', function() {
    overlayDismissed = true;
    document.getElementById('rotate-overlay').classList.remove('show');
});

function checkOrientation() {
    if (overlayDismissed) return;
    const overlay = document.getElementById('rotate-overlay');
    const isPortrait = window.matchMedia('(orientation: portrait)').matches;
    const isNarrow = window.innerWidth < 768;
    const isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
    overlay.classList.toggle('show', isPortrait && isNarrow && isTouchDevice);
}

// Reset dismiss state when user rotates back to landscape
window.matchMedia('(orientation: landscape)').addEventListener('change', function(e) {
    if (e.matches) overlayDismissed = false;
});

window.addEventListener('resize', checkOrientation);
checkOrientation();
</script>

</body>
</html>