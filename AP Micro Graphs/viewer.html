<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AP.Econ.Graphs</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Noto+Sans+SC:wght@300;400;500;700&family=Outfit:wght@300;400;500;600;700&family=Syne:wght@700;800&display=swap" rel="stylesheet" />
    
    <!-- KGJS Engine loaded dynamically after YAML is injected -->
    
    <style>
        /* ── THEME PALETTE ── */
        :root {
            --bg: #fcfbf9;
            --ink: #050e3c;
            --mid: #002455;
            --faint: #f2f0eb;
            --line: #e6e4e0;
            --red: #DC0000;
            --red-dim: #fce8e8;
            --blue: #0057ff;
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        
        body {
            background: #ffffff; 
            color: var(--ink);
            font-family: 'Outfit', 'Noto Sans SC', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            font-weight: 300; 
            line-height: 1.7;
            -webkit-font-smoothing: antialiased;
            opacity: 0; 
            transition: opacity 0.4s ease-in-out;
        }

        /* ── TOPBAR ── */
        .topbar {
            position: relative;
            z-index: 100;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 clamp(1rem,4vw,2rem); height: 64px;
            border-bottom: 1px solid var(--line);
            background: rgba(252,251,249,.95); backdrop-filter: blur(12px);
        }
        .logo {
            font-family: 'Syne', 'SF Pro Display', 'PingFang SC', sans-serif; font-weight: 800;
            font-size: clamp(.85rem,2vw,1.1rem); letter-spacing: -.02em;
            color: var(--ink); text-decoration: none;
        }
        .logo span { color: var(--red); }
        .topbar-right { display: flex; align-items: center; gap: 1rem; }
        .lang-toggle { display: flex; gap: 6px; }
        .lang-btn {
            background: none; border: 1px solid var(--line); border-radius: 6px;
            padding: .3rem .85rem; font-size: .78rem; font-family: inherit;
            cursor: pointer; color: var(--mid); transition: all .18s; font-weight: 500;
        }
        .lang-btn:hover { border-color: var(--mid); }
        .lang-btn.active { background: var(--ink); color: #fff; border-color: var(--ink); }

        /* ── PAGE HEADER & BREADCRUMBS ── */
        .page-header-wrap { border-bottom: 1px solid var(--line); background: #fff; }
        .page-header {
            max-width: 1100px; margin: 0 auto;
            padding: clamp(2rem,5vw,4rem) clamp(1rem,4vw,2rem) clamp(1rem,3vw,2rem);
        }
        .breadcrumb {
            font-size: .75rem; color: var(--mid);
            display: flex; align-items: center; gap: .4rem; flex-wrap: wrap;
            margin-bottom: 1.2rem;
            min-height: 1.2rem;
        }
        .back-btn {
            display: inline-flex; align-items: center; gap: .4rem;
            background: var(--faint); border: 1px solid var(--line);
            color: var(--ink); text-decoration: none; 
            font-family: 'Outfit', sans-serif; 
            font-weight: 600; font-size: .8rem; padding: .5rem 1.1rem;
            border-radius: 6px; transition: all .18s; cursor: pointer;
        }
        .back-btn:hover { background: var(--ink); color: #fff; border-color: var(--ink); }
        .breadcrumb .sep { color: var(--line); font-size: .9rem; margin: 0 .2rem; }
        .breadcrumb .folder-link {
            color: var(--mid); text-decoration: none; font-size: .85rem; transition: color .2s;
        }
        .breadcrumb .folder-link:hover { color: var(--ink); text-decoration: underline; }
        .breadcrumb .code-label { color: var(--mid); font-size: .85rem; }

        .page-eyebrow {
            font-size: clamp(.65rem,1.5vw,.75rem); letter-spacing: .15em;
            text-transform: uppercase; color: var(--mid);
            margin-bottom: 1rem; font-weight: 600;
            min-height: 1em;
        }
        .page-header h1 {
            font-family: 'Outfit', sans-serif; 
            font-weight: 700;
            font-size: clamp(2.2rem,6vw,3.8rem); 
            letter-spacing: -.02em; 
            line-height: 1.1; 
            color: var(--ink); 
            min-height: 1.1em;
        }

        /* ── DESCRIPTION ── */
        .page-desc {
            margin-top: 1.2rem;
            font-size: clamp(.95rem,2vw,1.05rem);
            color: var(--mid); 
            line-height: 1.7;
            max-width: 800px;
        }
        .page-desc p { margin-bottom: 0.8rem; }
        .page-desc strong { color: var(--ink); font-weight: 600; }
        .page-desc ol, .page-desc ul { margin-left: 1.5rem; margin-top: 0.5rem; margin-bottom: 0; }
        .page-desc li { margin-bottom: 0.3rem; }
        .page-desc li strong { color: var(--red); font-weight: 500; }
        :lang(zh) .page-desc { line-height: 1.8; letter-spacing: 0.02em; }

        /* ── LOADING / ERROR STATES ── */
        .state-msg {
            padding: 4rem 0; text-align: center;
            color: var(--mid); font-size: .9rem;
        }
        .spinner {
            width: 18px; height: 18px;
            border: 2px solid var(--line); border-top-color: var(--red);
            border-radius: 50%; animation: spin .7s linear infinite;
            display: inline-block; margin-right: .5rem; vertical-align: middle;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-msg { color: var(--red); }

        /* ── MAIN CONTENT ── */
        main {
            max-width: 1100px; margin: 0 auto;
            padding: 0 clamp(1rem,4vw,2rem) clamp(4rem,8vw,6rem);
        }

        /* ── GRAPH CONTAINER ── */
        .kg-container {
            max-width: 1100px; 
            margin: 3rem 0 0 0; 
            position: relative;
            background: #ffffff;
            border-radius: 12px;
            user-select: none;
            -webkit-user-select: none;
            opacity: 0;
            transition: opacity 0.4s ease;
        }
        .kg-container.ready { opacity: 1; }
        svg text { pointer-events: none; }

        /* ── FOOTER ── */
        .footer-wrap { border-top: 1px solid var(--line); background: #fff; }
        footer {
            max-width: 1100px; margin: 0 auto;
            padding: clamp(1.5rem,3vw,2rem) clamp(1rem,4vw,2rem);
            display: flex; flex-wrap: wrap; justify-content: space-between;
            align-items: center; gap: 1rem; font-size: .8rem; color: var(--mid);
        }
        footer a { color: var(--mid); text-decoration: none; transition: color .2s; }
        footer a:hover { color: var(--ink); }

        @media (max-width: 768px) {
            .page-header { padding-top: 2rem; padding-bottom: 2rem; }
            .kg-container { margin-top: 2rem; padding: 1rem; }
        }
    </style>
</head>
<body>

<header class="topbar">
    <a class="logo" href="../index.html"><span>AP</span>·Econ·Graphs</a>
    <div class="topbar-right">
        <div class="lang-toggle">
            <button class="lang-btn active" id="btn-en" onclick="setLang('en')">EN</button>
            <button class="lang-btn" id="btn-zh" onclick="setLang('zh')">中文</button>
        </div>
    </div>
</header>

<div class="page-header-wrap">
    <div class="page-header">
        <div class="breadcrumb">
            <a class="back-btn" href="javascript:history.back()" data-i18n="backBtn">⥃ Back</a>
            <span class="sep">/</span>
            <a href="index.html" class="folder-link" id="breadcrumb-folder"></a>
            <span class="sep">/</span>
            <span class="code-label" id="breadcrumb-code"></span>
        </div>
        <div class="page-eyebrow" id="page-eyebrow"></div>
        <h1 id="page-title"></h1>
        <div class="page-desc" id="page-desc"></div>
    </div>
</div>

<main>
    <div class="state-msg" id="state-msg">
        <span class="spinner"></span> <span id="loading-text">Loading graph…</span>
    </div>
    <div class="kg-container" id="kg-container"></div>
</main>

<div class="footer-wrap">
  <footer>
    <span>AP.Econ.Graphs · <a href="https://github.com/Raylaoshi/AP.Econ.Graphs" target="_blank">github.com/Raylaoshi</a></span>
    <span data-i18n="footerCredit">Built with KineticGraphs by Chris Makler</span>
  </footer>
</div>

<script>
// ── i18n strings ──
const T = {
  en: {
    backBtn:       '⥃ Back',
    footerCredit:  'Built with KineticGraphs by Chris Makler',
    loading:       'Loading graph…',
    errorNotFound: '⚠️ Graph not found. Make sure the .yaml file exists in the graphs/ folder.',
    errorNoId:     '⚠️ No graph specified. Add ?graph=3.2.G1 to the URL.',
  },
  zh: {
    backBtn:       '⥃ 返回',
    footerCredit:  '基于Chris Makler的KineticGraphs构建',
    loading:       '加载图表中…',
    errorNotFound: '⚠️ 找不到图表，请确认 .yaml 文件存在于 graphs/ 文件夹中。',
    errorNoId:     '⚠️ 未指定图表，请在 URL 中添加 ?graph=3.2.G1。',
  }
};

// Folder name translations
const FOLDER_ZH = {
  'AP Micro Graphs':      'AP微观经济图表',
  'AP Macro Graphs':      'AP宏观经济图表',
  'Previous Experiments': '图表试验',
};

let currentLang = 'en';
let meta = {};

function parseFrontMatter(yamlText) {
  const result = {
    title: '', title_zh: '',
    description: '', description_zh: '',
    label: '', eyebrow: '', eyebrow_zh: '',
  };

  const FIELDS = Object.keys(result);
  const lines = yamlText.split('\n');
  let i = 0;
  let blockKey = null;
  let blockLines = [];

  function flushBlock() {
    if (blockKey) {
      result[blockKey] = blockLines.join('\n').trimEnd();
      blockKey = null;
      blockLines = [];
    }
  }

  while (i < lines.length) {
    const line = lines[i];

    if (/^schema:/.test(line)) { flushBlock(); break; }

    if (blockKey !== null) {
      if (line.match(/^\s+/) || line.trim() === '') {
        blockLines.push(line.trim());
      } else {
        flushBlock();
        continue; // re-process this line without incrementing
      }
    } else {
      const m = line.match(/^([a-zA-Z_]+):\s*(.*)/);
      if (m && FIELDS.includes(m[1])) {
        const key = m[1];
        const val = m[2].trim();
        if (val === '|' || val === '>') {
          blockKey = key;
          blockLines = [];
        } else {
          result[key] = val.replace(/^["']|["']$/g, '');
        }
      }
    }
    i++;
  }

  flushBlock();
  return result;
}

// Strip front-matter lines, keep everything from 'schema:' onward
function stripFrontMatter(yamlText) {
  const lines = yamlText.split('\n');
  let started = false;
  return lines.filter(line => {
    if (line.startsWith('schema:')) started = true;
    return started;
  }).join('\n');
}

function getFolderName() {
  const parts = window.location.pathname.split('/');
  return decodeURIComponent(parts[parts.length - 2] || '') || 'AP Micro Graphs';
}

function render(lang) {
  const t = T[lang];

  // i18n static strings
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if (t[key] !== undefined) el.textContent = t[key];
  });

  // Breadcrumb folder
  const folderName = getFolderName();
  document.getElementById('breadcrumb-folder').textContent =
    lang === 'zh' ? (FOLDER_ZH[folderName] || folderName) : folderName;

  // Code label
  document.getElementById('breadcrumb-code').textContent = meta.label || '';

  // Eyebrow
  document.getElementById('page-eyebrow').textContent =
    (lang === 'zh' && meta.eyebrow_zh) ? meta.eyebrow_zh : (meta.eyebrow || '');

  // Title
  document.getElementById('page-title').textContent =
    (lang === 'zh' && meta.title_zh) ? meta.title_zh : (meta.title || '');

  // Description (innerHTML to support <p>, <ol>, <strong> etc.)
  document.getElementById('page-desc').innerHTML =
    (lang === 'zh' && meta.description_zh) ? meta.description_zh : (meta.description || '');

  document.getElementById('btn-en').classList.toggle('active', lang === 'en');
  document.getElementById('btn-zh').classList.toggle('active', lang === 'zh');
  document.documentElement.lang = lang === 'zh' ? 'zh' : 'en';
}

function setLang(lang) {
  currentLang = lang;
  render(lang);
  try { localStorage.setItem('econ-lang', lang); } catch(e) {}
}

function detectLang() {
  try {
    const saved = localStorage.getItem('econ-lang');
    if (saved === 'en' || saved === 'zh') return saved;
  } catch(e) {}
  return (navigator.language || '').toLowerCase().startsWith('zh') ? 'zh' : 'en';
}

function showError(msg) {
  const el = document.getElementById('state-msg');
  el.innerHTML = `<span class="error-msg">${msg}</span>`;
  el.style.display = 'block';
}

async function init() {
  currentLang = detectLang();

  const urlParams = new URLSearchParams(window.location.search);
  const graphId   = urlParams.get('graph');

  if (!graphId) {
    render(currentLang);
    document.body.style.opacity = '1';
    showError(T[currentLang].errorNoId);
    return;
  }

  try {
    const res = await fetch(`graphs/${encodeURIComponent(graphId)}.yaml?v=${Date.now()}`);
    if (!res.ok) throw new Error('YAML not found');
    const yamlText = await res.text();

    // Extract metadata from front-matter
    meta = parseFrontMatter(yamlText);
    document.title = `${meta.title || graphId} — AP.Econ.Graphs`;

    // Render UI with metadata
    render(currentLang);

    // Inject graph YAML into KG container
    const kgEl = document.getElementById('kg-container');
    kgEl.textContent = stripFrontMatter(yamlText);

    // Hide loader
    document.getElementById('state-msg').style.display = 'none';

    // Load KG CSS then JS dynamically — guarantees KG scans DOM after YAML is present
    const kgCSS = document.createElement('link');
    kgCSS.rel = 'stylesheet';
    kgCSS.href = 'https://raylaoshi.github.io/AP.Econ.Graphs/lib/kg.0.4.0.css';
    document.head.appendChild(kgCSS);

    await new Promise((resolve, reject) => {
      const kgJS = document.createElement('script');
      kgJS.src = 'https://raylaoshi.github.io/AP.Econ.Graphs/lib/kg.0.4.0.js';
      kgJS.onload = resolve;
      kgJS.onerror = reject;
      document.head.appendChild(kgJS);
    });

    // KG has now initialised — reveal graph
    setTimeout(() => { kgEl.classList.add('ready'); }, 200);

    // Prevent full SVG drag
    kgEl.addEventListener('mousedown', e => {
      if (e.target.closest('svg')) e.preventDefault();
    }, true);

  } catch(err) {
    render(currentLang);
    showError(T[currentLang].errorNotFound);
    console.error(err);
  }

  // Reveal page — font gate with 800ms fallback
  document.fonts.ready.then(() => { document.body.style.opacity = '1'; });
  setTimeout(() => { document.body.style.opacity = '1'; }, 800);
}

document.addEventListener('DOMContentLoaded', init);
</script>
 
</body>
</html>